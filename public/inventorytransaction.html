<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Lunch Rush Database</title>
    <link href="styles.css" rel="stylesheet" />
  </head>
  <body>
    <header>
      <div id="header-image">
        <img src="Lunch_Rush_3.png" />
      </div>
    </header>
    <div id="grid-container">
      <nav>
        <ul>
          <li><a href="/index.html">Home</a></li>
          <li><a href="/stores.html">Stores</a></li>
          <li><a href="/menu.html">Menu</a></li>
          <li><a href="/inventory.html">Log Inventory</a></li>
          <li><a href="/inventorytransaction.html">Exchange Inventory</a></li>
          <li><a href="/ordering.html">Ordering</a></li>
          <li><a href="/reporting-analytics.html">Reporting &<br>Analytics</a></li>
        </ul>
      </nav>
      <main>
        <h2>Inventory Transaction Form</h2>
        <section id="form">
          <form id="inventory-transaction-form" class="dynamic-ingredient-form" action="https://wp.zybooks.com/form-viewer.php" method="POST">
						<div class="result-message" id="result-message"></div>
						<div id="ingredients-container">
              <!-- Ingredient input sections will be dynamically added here -->
            </div>
            <button type="button" id="add-ingredient-btn" class="submit-button">Add Ingredient...</button>
            <span>Location:</span>
            <select name="locations" id="locations" class="location-selector">
							<option value=1>678 Mountain Vista Ave</option>
							<option value=2>981 Sunset Rd</option>
							<option value=3>45 Eastern Rd</option>
						</select>
            <label for="outgoing">Outgoing Location</label>
            <input type="radio" id="outgoing" name="locationType" value="outgoing">
            <label for="incoming">Incoming Location</label>
            <input type="radio" id="incoming" name="locationType" value="incoming">
            <input type="submit" value="Log Inventory Transaction" class="submit-button"/>
          </form>
        </section>
      </main>
    </div>
    <footer>
      <p>Group 14 IFT 402 Fall 2023</p>
    </footer>
  
    <script>
      var inventoryTransactionForm = document.getElementById("inventory-transaction-form");
      var ingredientsContainer = document.getElementById("ingredients-container");
      var addIngredientButton = document.getElementById("add-ingredient-btn");
      var ingredientCounter = 1;
      var deleteButton = null;
  
      addIngredientButton.addEventListener("click", createIngredientSection);

      function createIngredientSection() {
        var div = document.createElement("div");
        var select = document.createElement("select");
        var quantityInput = document.createElement("input");
        var measurementUnit = document.createElement("span");
        var quantityLabel = document.createElement("span");
  
        div.className = "ingredient-section";
        select.id = "ingredient-" + ingredientCounter;
        select.name = "ingredient-" + ingredientCounter;
        select.className = "ingredient-dropdown";
				quantityInput.id = "quantity-" + ingredientCounter;
        quantityInput.className = "form-input-box";
        quantityLabel.className = "quantity-label";
        quantityLabel.textContent = "Quantity: ";

        var ingredientOptions = [
          "Bread Rolls",
          "Mayonnaise",
          "Mustard",
          "Ranch Dressing",
          "Sliced Turkey",
          "Sliced Ham",
          "Rotisserie Chicken",
          "Bacon",
          "Cheese",
          "Lettuce",
          "Tomato"
        ];

        for (var i = 0; i < ingredientOptions.length; i++) {
          var option = document.createElement("option");
          option.value = i + 1; // Option values start from 1
          option.textContent = ingredientOptions[i];
          select.appendChild(option);
        }

        var ingredientsContainer = document.getElementById("ingredients-container");
        ingredientsContainer.appendChild(select);
      
        quantityInput.type = "number";
        quantityInput.name = "quantity-" + ingredientCounter;
        quantityInput.required = true;
        quantityInput.min = "1";
        quantityInput.value = "1";
  
        measurementUnit.id = "measurementUnit-" + ingredientCounter;
        measurementUnit.textContent = "Rolls";
  
        if (ingredientCounter > 1) {
          deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.className = "delete-button";
          deleteButton.addEventListener("click", function() {
            ingredientsContainer.removeChild(div);
						ingredientCounter--;
          });
        }
  
        div.appendChild(select);
        div.appendChild(quantityLabel);
        div.appendChild(quantityInput);
        div.appendChild(measurementUnit);
        
        if (deleteButton) {
          div.appendChild(deleteButton);
        }

        ingredientsContainer.appendChild(div);
  
        select.addEventListener("change", function() {
          updateMeasurementUnit(select, measurementUnit);
        });
  
        ingredientCounter++;
      }
  
      function updateMeasurementUnit(select, measurementUnit) {
        var selectedOption = parseInt(select.value);
        if (selectedOption == 1) {
          measurementUnit.textContent = "Rolls";
        } else if (selectedOption >= 2 && selectedOption <= 4) {
          measurementUnit.textContent = "Fl oz";
        } else {
          measurementUnit.textContent = "Oz";
        }
      }
  
      createIngredientSection();

			document.addEventListener("DOMContentLoaded", function () {
        var form = document.querySelector("form");
        var resultMessage = document.getElementById("result-message")

				form.addEventListener("submit", async function (event) {
					event.preventDefault();

					try {
						// Get user info
						const userInfoResponse = await fetch('/api/users/userInfo');
						const userInfo = await userInfoResponse.json();

						const outgoingRadio = document.getElementById("outgoing");
   					const incomingRadio = document.getElementById("incoming");

						if (!outgoingRadio.checked && !incomingRadio.checked) {
								setResultMessage("Please select whether the chosen location is the outgoing or incoming location.", 'error');
								return;
						}

						const selectedLocationID = parseInt(document.getElementById("locations").value, 10);

						if (selectedLocationID === userInfo.locationID) {
							setResultMessage("The location you've selected is the same as your own location. Please choose a different location.", 'error');
							return;
						}

						// Get the latest inventory transaction ID
						let outgoingLocationID, incomingLocationID;
						if (outgoingRadio.checked) {
							outgoingLocationID = selectedLocationID;
							incomingLocationID = userInfo.locationID;
						} else if (incomingRadio.checked) {
							outgoingLocationID = userInfo.locationID;
							incomingLocationID = selectedLocationID;
						}

						const latestTransactionIDResponse = await fetch(`/api/inventoryTransactions/inventoryTransactions/latestID/${outgoingLocationID}`);
						const latestTransactionIDData = await latestTransactionIDResponse.json();
						const latestTransactionID = latestTransactionIDData[0].inventoryTransactionID;

						// Prepare data for inventory transaction
						const inventoryTransactionObject = {
							inventoryTransactionID: latestTransactionID + 1,
							outgoingLocationID: outgoingLocationID,
							incomingLocationID: incomingLocationID,
							date: getCurrentDateInPhoenix(),
						};

						// Prepare data for inventory transaction line items
						const ingredients = [];
						for (let i = 1; i < ingredientCounter; i++) {
							const ingredientID = parseInt(document.getElementById(`ingredient-${i}`).value);
							const inputID = "ingredient-" + i;
							const quantity = parseInt(document.getElementById(`quantity-${i}`).value);

							const ingredientObject = {
								inventoryTransactionID: inventoryTransactionObject.inventoryTransactionID,
								ingredientID: ingredientID,
								quantity: quantity,
							};

							ingredients.push(ingredientObject);
						}

						// Post inventory transaction
						const postTransactionResponse = await fetch(`/api/inventoryTransactions/inventoryTransactions`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify(inventoryTransactionObject),
						});

						// Post inventory transaction line items
						for (const ingredientObject of ingredients) {
							try {
								const postLineItemsResponse = await fetch(`/api/inventoryTransactions/inventoryTransactions/lineItems`, {
									method: 'POST',
									headers: {
										'Content-Type': 'application/json',
									},
									body: JSON.stringify(ingredientObject),
								});

								const result = await postLineItemsResponse.json();
							} catch (error) {
								console.error('Error posting line item:', error);
								setResultMessage('An error occurred. Please try again later.', 'error');
								return;
							}
						}
								
						setResultMessage('The inventory transaction was saved successfully.', 'success');

						} catch (error) {
							console.error('Error:', error);
								setResultMessage('An error occurred. Please try again later.', 'error');
						}
				});

				function setResultMessage(message, messageType) {
					resultMessage.innerText = message;
					resultMessage.style.display = 'block';
					resultMessage.className = messageType;
				}

				function getCurrentDateInPhoenix() {
							var utcDate = new Date();
							var phoenixOffset = -7 * 60; // Phoenix is UTC-7
							var phoenixDate = new Date(utcDate.getTime() + phoenixOffset * 60 * 1000);

							// Get the date in YYYY-MM-DD format
							var formattedDate = phoenixDate.toISOString().split('T')[0];
							return formattedDate;
				}
			});
    </script>
  </body>
</html>